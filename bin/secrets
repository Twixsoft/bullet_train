#!/usr/bin/env bash

echo "Generating secret key and encrypted credentials for development."
EDITOR="cat" bin/rails credentials:edit >> /dev/null
# This makes sure we add `/config/credentials/development.key` to `.gitignore`.
EDITOR="cat" bin/rails credentials:edit --environment development >> /dev/null
mv config/master.key config/credentials/development.key
mv config/credentials.yml.enc config/credentials/development.yml.enc

echo "Generating secret key and encrypted credentials for test."
EDITOR="cat" bin/rails credentials:edit >> /dev/null
# This makes sure we add `/config/credentials/test.key` to `.gitignore`.
EDITOR="cat" bin/rails credentials:edit --environment test >> /dev/null
mv config/master.key config/credentials/test.key
mv config/credentials.yml.enc config/credentials/test.yml.enc

echo "Generating secret key and encrypted credentials for production."
EDITOR="cat" bin/rails credentials:edit >> /dev/null
# This makes sure we add `/config/credentials/production.key` to `.gitignore`.
EDITOR="cat" bin/rails credentials:edit --environment production >> /dev/null
mv config/master.key config/credentials/production.key
mv config/credentials.yml.enc config/credentials/production.yml.enc

echo "Finally, generating master secret key and global encrypted credentials."
# This generates a key.
EDITOR="cat" bin/rails credentials:edit >> /dev/null
# This removes `secret_key_base` from the file, because we want that to be set on a per-environment basis.
EDITOR="echo \"# aws:\n#   access_key_id: 123\n#   secret_access_key: 345\n\n\" > " bin/rails credentials:edit
